from machine import Pin
from machine import ADC
from machine import DAC
from math import log

import machine
import utime
class Thermometer():
    #temperary
    def __init__(self,TENP_SENS_ADC_PIN_NO):
        
        self.adc_V_lookup = [0.01852941, 0.02470588, 0.02058824, 0.04117647, 0.06176471, 0.06485295, 0.06794118, 0.07102942, 0.07411765, 0.0782353, 0.08235294, 0.08647059, 0.09058825, 0.09470588, 0.09882354, 0.1019118, 0.105, 0.1080882, 0.1111765, 0.1152941, 0.1194118, 0.1235294, 0.126, 0.1284706, 0.1309412, 0.1334118, 0.1358824, 0.1389706, 0.1420588, 0.1451471, 0.1482353, 0.1544118, 0.1605882, 0.1667647, 0.1729412, 0.175, 0.1770588, 0.1791177, 0.1811765, 0.1832353, 0.1852941, 0.1877647, 0.1902353, 0.1927059, 0.1951765, 0.2038235, 0.2038235, 0.21, 0.2161765, 0.222353, 0.2248235, 0.2272941, 0.2297647, 0.2322353, 0.2347059, 0.2388236, 0.2429412, 0.2470588, 0.2511765, 0.2552941, 0.2594118, 0.2611765, 0.2629412, 0.2647059, 0.2664706, 0.2682353, 0.27, 0.2717647, 0.2841177, 0.2865882, 0.2890588, 0.2915294, 0.294, 0.2964706, 0.3026471, 0.3088235, 0.315, 0.3211765, 0.3242647, 0.327353, 0.3304412, 0.3335294, 0.336, 0.3384706, 0.3409412, 0.3434118, 0.3458824, 0.3489706, 0.3520588, 0.3551471, 0.3582353, 0.3613235, 0.3644118, 0.3675, 0.3705883, 0.3736765, 0.3767647, 0.379853, 0.3891177, 0.3870588, 0.3911765, 0.3952941, 0.3994118, 0.4035295, 0.4076471, 0.4107353, 0.4138236, 0.4169118, 0.42, 0.4261765, 0.432353, 0.4354412, 0.4385294, 0.4416177, 0.4447059, 0.4477942, 0.4508824, 0.4539706, 0.4570589, 0.4632353, 0.4694118, 0.4718824, 0.474353, 0.4768235, 0.4792941, 0.4817647, 0.4842353, 0.4867059, 0.4891765, 0.4916471, 0.4941177, 0.5064706, 0.5095589, 0.5126471, 0.5157353, 0.5188236, 0.5212941, 0.5237647, 0.5262353, 0.5287059, 0.537353, 0.5352941, 0.5394118, 0.5435295, 0.547647, 0.5517647, 0.5558824, 0.56, 0.5641177, 0.5682353, 0.57, 0.5717647, 0.5735294, 0.5752941, 0.5770588, 0.5788236, 0.5805883, 0.5929412, 0.5970588, 0.6011765, 0.6052941, 0.607353, 0.6094118, 0.6114706, 0.6135294, 0.6155882, 0.6176471, 0.6217647, 0.6258824, 0.63, 0.6341177, 0.6382353, 0.642353, 0.6454412, 0.6485294, 0.6516176, 0.6547059, 0.6577941, 0.6608824, 0.6639706, 0.6670588, 0.6732353, 0.6794118, 0.6855883, 0.6917647, 0.6938236, 0.6958824, 0.6979412, 0.7, 0.7020588, 0.7041177, 0.7164706, 0.7189412, 0.7214118, 0.7238824, 0.7263529, 0.7288236, 0.7329412, 0.7370589, 0.7411765, 0.7442647, 0.747353, 0.7504412, 0.7535295, 0.756, 0.7584706, 0.7609412, 0.7634118, 0.7658824, 0.77, 0.7741177, 0.7782353, 0.7807059, 0.7831765, 0.785647, 0.7881176, 0.7905883, 0.7930588, 0.7955295, 0.798, 0.8004706, 0.8029412, 0.8070589, 0.8111765, 0.8152942, 0.8177647, 0.8202353, 0.8227058, 0.8251765, 0.8276471, 0.8338236, 0.8400001, 0.8441177, 0.8482353, 0.852353, 0.8564707, 0.8605883, 0.8647059, 0.8671764, 0.8696471, 0.8721176, 0.8745883, 0.8770589, 0.8894118, 0.8918823, 0.894353, 0.8968235, 0.8992942, 0.9017648, 0.9058825, 0.91, 0.9141177, 0.9158824, 0.9176471, 0.9194118, 0.9211765, 0.9229412, 0.9247059, 0.9264707, 0.9305883, 0.9347058, 0.9388236, 0.9419118, 0.9450001, 0.9480883, 0.9511765, 0.953647, 0.9561177, 0.9585882, 0.9610589, 0.9635295, 0.9758824, 0.9783529, 0.9808236, 0.9832941, 0.9857648, 0.9882354, 0.9907059, 0.9931766, 0.995647, 0.9981177, 1.000588, 1.006765, 1.012941, 1.016029, 1.019118, 1.022206, 1.025294, 1.028382, 1.031471, 1.034559, 1.037647, 1.041765, 1.045882, 1.05, 1.054118, 1.058235, 1.062353, 1.064824, 1.067294, 1.069765, 1.072235, 1.074706, 1.078824, 1.082941, 1.087059, 1.089529, 1.092, 1.094471, 1.096941, 1.099412, 1.105588, 1.111765, 1.114853, 1.117941, 1.121029, 1.124118, 1.127206, 1.130294, 1.133382, 1.136471, 1.140588, 1.144706, 1.148824, 1.151912, 1.155, 1.158088, 1.161177, 1.167353, 1.17353, 1.176618, 1.179706, 1.182794, 1.185882, 1.19, 1.194118, 1.198235, 1.200294, 1.202353, 1.204412, 1.206471, 1.208529, 1.210588, 1.216765, 1.222941, 1.229118, 1.235294, 1.236838, 1.238382, 1.239926, 1.241471, 1.243015, 1.244559, 1.246103, 1.247647, 1.253824, 1.26, 1.263088, 1.266176, 1.269265, 1.272353, 1.278529, 1.284706, 1.287794, 1.290882, 1.293971, 1.297059, 1.303235, 1.309412, 1.3125, 1.315588, 1.318676, 1.321765, 1.325882, 1.33, 1.334118, 1.336177, 1.338235, 1.340294, 1.342353, 1.344412, 1.346471, 1.352647, 1.358824, 1.361294, 1.363765, 1.366235, 1.368706, 1.371176, 1.373235, 1.375294, 1.377353, 1.379412, 1.381471, 1.383529, 1.387647, 1.391765, 1.395882, 1.4, 1.404118, 1.408235, 1.411324, 1.414412, 1.4175, 1.420588, 1.424706, 1.428824, 1.432941, 1.436029, 1.439118, 1.442206, 1.445294, 1.447765, 1.450235, 1.452706, 1.455177, 1.457647, 1.461765, 1.465882, 1.47, 1.476177, 1.482353, 1.485441, 1.488529, 1.491618, 1.494706, 1.497177, 1.499647, 1.502118, 1.504588, 1.507059, 1.511177, 1.515294, 1.519412, 1.5225, 1.525588, 1.528677, 1.537941, 1.535882, 1.54, 1.544118, 1.548235, 1.552353, 1.556471, 1.560588, 1.564706, 1.568824, 1.571294, 1.573765, 1.576235, 1.578706, 1.581177, 1.587353, 1.593529, 1.596, 1.598471, 1.600941, 1.603412, 1.605882, 1.61, 1.614118, 1.618235, 1.620706, 1.623176, 1.625647, 1.628118, 1.630588, 1.634706, 1.638824, 1.642941, 1.649118, 1.655294, 1.658382, 1.661471, 1.664559, 1.667647, 1.670735, 1.673824, 1.676912, 1.68, 1.684118, 1.688235, 1.692353, 1.695441, 1.698529, 1.701618, 1.704706, 1.708824, 1.712941, 1.717059, 1.719529, 1.722, 1.724471, 1.726941, 1.729412, 1.735588, 1.741765, 1.743824, 1.745882, 1.747941, 1.75, 1.752059, 1.754118, 1.756588, 1.759059, 1.76153, 1.764, 1.766471, 1.778824, 1.780882, 1.782941, 1.785, 1.787059, 1.789118, 1.791177, 1.795294, 1.799412, 1.80353, 1.806618, 1.809706, 1.812794, 1.815882, 1.818353, 1.820824, 1.823294, 1.825765, 1.828235, 1.834412, 1.840588, 1.844706, 1.848824, 1.852941, 1.85603, 1.859118, 1.862206, 1.865294, 1.869412, 1.87353, 1.877647, 1.881765, 1.885882, 1.89, 1.892471, 1.894941, 1.897412, 1.899882, 1.902353, 1.908529, 1.914706, 1.927059, 1.928824, 1.930588, 1.932353, 1.934118, 1.935882, 1.937647, 1.939412, 1.9425, 1.945588, 1.948677, 1.951765, 1.957941, 1.964118, 1.966588, 1.969059, 1.97153, 1.974, 1.976471, 1.980588, 1.984706, 1.988824, 1.995, 2.001177, 2.005294, 2.009412, 2.01353, 2.015588, 2.017647, 2.019706, 2.021765, 2.023823, 2.025882, 2.032059, 2.038235, 2.041324, 2.044412, 2.0475, 2.050588, 2.054706, 2.058824, 2.062941, 2.06603, 2.069118, 2.072206, 2.075294, 2.081471, 2.087647, 2.090735, 2.093824, 2.096912, 2.1, 2.102059, 2.104118, 2.106177, 2.108235, 2.110294, 2.112353, 2.11853, 2.124706, 2.127177, 2.129647, 2.132118, 2.134588, 2.137059, 2.143235, 2.149412, 2.151471, 2.153529, 2.155588, 2.157647, 2.159706, 2.161765, 2.165882, 2.17, 2.174118, 2.177206, 2.180294, 2.183383, 2.186471, 2.190588, 2.194706, 2.198824, 2.200882, 2.202941, 2.205, 2.207059, 2.209118, 2.211177, 2.22353, 2.225588, 2.227647, 2.229706, 2.231765, 2.233824, 2.235883, 2.242059, 2.248235, 2.250706, 2.253176, 2.255647, 2.258118, 2.260588, 2.264706, 2.268824, 2.272941, 2.27603, 2.279118, 2.282206, 2.285294, 2.289412, 2.29353, 2.297647, 2.301765, 2.305882, 2.31, 2.313088, 2.316177, 2.319265, 2.322353, 2.324412, 2.326471, 2.32853, 2.330588, 2.332647, 2.334706, 2.347059, 2.34953, 2.352, 2.354471, 2.356941, 2.359412, 2.365588, 2.371765, 2.373529, 2.375294, 2.377059, 2.378824, 2.380588, 2.382353, 2.384118, 2.387206, 2.390294, 2.393382, 2.396471, 2.399559, 2.402647, 2.405735, 2.408823, 2.411294, 2.413765, 2.416235, 2.418706, 2.421176, 2.427353, 2.433529, 2.437647, 2.441765, 2.445882, 2.448971, 2.452059, 2.455147, 2.458235, 2.464412, 2.470588, 2.472647, 2.474706, 2.476765, 2.478824, 2.480882, 2.482941, 2.486029, 2.489118, 2.492206, 2.495294, 2.498382, 2.501471, 2.504559, 2.507647, 2.510118, 2.512588, 2.515059, 2.517529, 2.52, 2.524118, 2.528235, 2.532353, 2.535441, 2.538529, 2.541618, 2.544706, 2.547794, 2.550882, 2.553971, 2.557059, 2.55953, 2.562, 2.564471, 2.566941, 2.569412, 2.571882, 2.574353, 2.576824, 2.579294, 2.581765, 2.584853, 2.587941, 2.591029, 2.594118, 2.596177, 2.598235, 2.600294, 2.602353, 2.604412, 2.612647, 2.610588, 2.614706, 2.618824, 2.622941, 2.627059, 2.631176, 2.634265, 2.637353, 2.640441, 2.643529, 2.645588, 2.647647, 2.649706, 2.651765, 2.653824, 2.655882, 2.658353, 2.660824, 2.663294, 2.665765, 2.668235, 2.670294, 2.672353, 2.674412, 2.676471, 2.67853, 2.680588, 2.682647, 2.684706, 2.686765, 2.688824, 2.690882, 2.692941, 2.699118, 2.705294, 2.708382, 2.711471, 2.714559, 2.717647, 2.719706, 2.721765, 2.723824, 2.725883, 2.727941, 2.73, 2.732471, 2.734941, 2.737412, 2.739882, 2.742353, 2.744118, 2.745883, 2.747647, 2.749412, 2.751176, 2.752941, 2.760882, 2.757176, 2.759647, 2.762118, 2.764588, 2.767059, 2.769529, 2.772, 2.774471, 2.776941, 2.779412, 2.7825, 2.785588, 2.788677, 2.791765, 2.794235, 2.796706, 2.799177, 2.801647, 2.804118, 2.806177, 2.808235, 2.810294, 2.812353, 2.814412, 2.816471, 2.822647, 2.828824, 2.830368, 2.831912, 2.833456, 2.835, 2.836544, 2.838088, 2.839633, 2.841177, 2.843235, 2.845294, 2.847353, 2.849412, 2.851471, 2.853529, 2.856618, 2.859706, 2.862794, 2.865882, 2.867427, 2.868971, 2.870515, 2.872059, 2.873603, 2.875147, 2.876691, 2.878235, 2.882353, 2.886471, 2.890588, 2.891711, 2.892834, 2.893957, 2.89508, 2.896203, 2.897326, 2.898449, 2.899572, 2.900695, 2.901818, 2.902941, 2.915294, 2.917353, 2.919412, 2.921471, 2.92353, 2.925588, 2.927647, 2.929412, 2.931177, 2.932941, 2.934706, 2.936471, 2.938235, 2.94, 2.942059, 2.944118, 2.946177, 2.948236, 2.950294, 2.952353, 2.953897, 2.955441, 2.956985, 2.958529, 2.960074, 2.961618, 2.963162, 2.964706, 2.966471, 2.968235, 2.97, 2.971765, 2.973529, 2.975294, 2.977059, 2.979118, 2.981177, 2.983235, 2.985294, 2.987353, 2.989412, 2.990956, 2.9925, 2.994044, 2.995588, 2.997132, 2.998676, 3.000221, 3.001765, 3.003824, 3.005883, 3.007941, 3.01, 3.012059, 3.014118, 3.016588, 3.019059, 3.02153, 3.024, 3.026471, 3.028235, 3.03, 3.031765, 3.03353, 3.035294, 3.037059, 3.038824, 3.040368, 3.041912, 3.043456, 3.045, 3.046544, 3.048088, 3.049633, 3.051177, 3.055294, 3.059412, 3.063529, 3.064652, 3.065776, 3.066898, 3.068022, 3.069144, 3.070267, 3.071391, 3.072514, 3.073636, 3.074759, 3.075882, 3.078971, 3.082059, 3.085147, 3.088235, 3.090294, 3.092353, 3.094412, 3.096471, 3.098529, 3.100588, 3.101961, 3.103333, 3.104706, 3.106079, 3.107451, 3.108824, 3.110196, 3.111569, 3.112941, 3.114706, 3.116471, 3.118235, 3.12, 3.121765, 3.12353, 3.125294, 3.126838, 3.128382, 3.129927, 3.131471, 3.133015, 3.134559, 3.136103, 3.137647, 3.140118, 3.142588, 3.145059, 3.14753, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15]
        self.NOM_RES = 10000
        self.SER_RES = 9820
        self.TEMP_NOM = 25
        self.NUM_SAMPLES = 1000
        self.THERM_B_COEFF = 3950
        self.ADC_MAX = 1023
        self.ADC_Vmax = 3.15
        
        self.adc = ADC(Pin(TENP_SENS_ADC_PIN_NO))
        self.adc.atten(ADC.ATTN_11DB)
        self.adc.width(ADC.WIDTH_10BIT)
        
    
    def read(self):
        raw_read = []
        # Collect NUM_SAMPLES
        for i in range(1, self.NUM_SAMPLES+1):
            raw_read.append(self.adc.read())
    
        # Average of the NUM_SAMPLES and look it up in the table
        raw_average = sum(raw_read)/self.NUM_SAMPLES
        #print('raw_avg = ' + str(raw_average))
        #print('V_measured = ' + str(self.adc_V_lookup[round(raw_average)]))
    
        # Convert to resistance
        raw_average = self.ADC_MAX * self.adc_V_lookup[round(raw_average)]/self.ADC_Vmax
        resistance = (self.SER_RES * raw_average) / (self.ADC_MAX - raw_average)
        #print('Thermistor resistance: {} ohms'.format(resistance))
    
        # Convert to temperature
        steinhart  = log(resistance / self.NOM_RES) / self.THERM_B_COEFF
        steinhart += 1.0 / (self.TEMP_NOM + 273.15)
        steinhart  = (1.0 / steinhart) - 273.15
        return steinhart
    
    
    def test(self):
        print("I'm alive!\n")
        utime.sleep_ms(2000)
        sample_last_ms = 0
        SAMPLE_INTERVAL = 1000
        
        while (True):
            if utime.ticks_diff(utime.ticks_ms(), sample_last_ms) >= SAMPLE_INTERVAL:
                temp = self.read()
                print('Thermistor temperature: ' + str(temp))
                sample_last_ms = utime.ticks_ms()
